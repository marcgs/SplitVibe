name: Validate PR

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

concurrency:
  group: validate-${{ github.event.workflow_run.head_branch }}
  cancel-in-progress: true

env:
  MAX_VALIDATION_ITERATIONS: "3"

jobs:
  validate:
    name: Copilot Validation
    runs-on: ubuntu-latest
    # Only run when CI succeeded, on a PR, from the same repo (not forks).
    if: >-
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.head_repository.full_name == github.repository

    steps:
      - name: Resolve PR number
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            // workflow_run doesn't directly carry the PR number — look it up.
            const headBranch = context.payload.workflow_run.head_branch;
            const headSha = context.payload.workflow_run.head_sha;

            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${headBranch}`,
            });

            const pr = prs.find(p => p.head.sha === headSha);
            if (!pr) {
              core.setFailed(`No open PR found for branch ${headBranch} at ${headSha}`);
              return;
            }

            core.info(`Resolved PR #${pr.number} for branch ${headBranch}`);
            core.setOutput('number', pr.number);

      - name: Count existing validation iterations
        id: guard
        uses: actions/github-script@v7
        with:
          script: |
            const max = parseInt(process.env.MAX_VALIDATION_ITERATIONS, 10);
            const prNumber = parseInt('${{ steps.pr.outputs.number }}', 10);

            const comments = await github.paginate(
              github.rest.issues.listComments,
              { owner: context.repo.owner, repo: context.repo.repo, issue_number: prNumber }
            );

            const count = comments.filter(c =>
              c.body?.includes('## Validation Report')
            ).length;

            core.info(`Found ${count} validation report(s) (max: ${max})`);
            core.setOutput('count', count);
            core.setOutput('max_reached', count >= max);

      - name: Trigger Copilot validation via comment
        if: steps.guard.outputs.max_reached == 'false'
        uses: actions/github-script@v7
        with:
          # Use a real-user PAT so the @copilot mention is not ignored
          # (the coding agent ignores bot-authored mentions).
          github-token: ${{ secrets.COPILOT_PAT }}
          script: |
            const prNumber = parseInt('${{ steps.pr.outputs.number }}', 10);
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: [
                '@copilot Use the **validate-pr** skill on this PR.',
                '',
                'Instructions:',
                '- Invoke the `validate-pr` skill (defined in `.github/agents/validate-pr.agent.md`).',
                '- The skill will validate acceptance criteria and post a **Validation Report** comment on this PR.',
                '- **Do NOT create a new branch or open a new pull request.** Only post the validation report as a comment here.',
              ].join('\n')
            });
            core.info(`Posted @copilot validation trigger on PR #${prNumber}`);

      - name: Post max-iterations notice
        if: steps.guard.outputs.max_reached == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = parseInt('${{ steps.pr.outputs.number }}', 10);
            const count = parseInt('${{ steps.guard.outputs.count }}', 10);
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: [
                '## ⚠️ Manual Review Needed',
                '',
                `This PR has reached the maximum number of automated validation iterations (${count}).`,
                'Further agentic validation has been paused to prevent an infinite loop.',
                '',
                'A human reviewer should:',
                '1. Review the latest validation report on this PR.',
                '2. Determine if remaining failures need manual intervention.',
                '3. Push fixes directly or provide instructions in a comment.'
              ].join('\n')
            });
